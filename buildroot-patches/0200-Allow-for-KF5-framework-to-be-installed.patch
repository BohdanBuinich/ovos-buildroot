From eec61f4acf2b47fbc6536478f98c2568cda092e6 Mon Sep 17 00:00:00 2001
From: Peter Steenbergen <info@j1nx.nl>
Date: Wed, 29 Apr 2020 08:40:29 +0200
Subject: [PATCH 1/1] Allow for KF5 framework to be installed

---
 .../kf5-extra-cmake-modules.hash              |  1 +
 .../kf5-extra-cmake-modules.mk                |  1 +
 .../kf5/kf5-kcoreaddons/kf5-kcoreaddons.hash  |  1 +
 .../kf5/kf5-kcoreaddons/kf5-kcoreaddons.mk    |  3 ++
 package/kf5/kf5.mk                            |  2 +-
 package/qt5/qt5base/qt5base.mk                | 52 +++++++++++++++++++
 package/qt5/qt5declarative/qt5declarative.mk  | 15 ++++++
 package/qt5/qt5tools/qt5tools.mk              | 24 +++++++++
 package/qt5/qt5xmlpatterns/qt5xmlpatterns.mk  | 15 ++++++
 9 files changed, 113 insertions(+), 1 deletion(-)

diff --git a/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.hash b/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.hash
index 733e267fdb..99cf3015ca 100644
--- a/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.hash
+++ b/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.hash
@@ -1,3 +1,4 @@
 # Locally calculated
 sha256 976d8bd15a0b929376bfaef34602a0fb9614229851c46fac3c4b28938f682195 extra-cmake-modules-5.47.0.tar.xz
+sha256 dacc8e0be8605b6c609ea35bda2d87bf06e1d228bcbf8957b0f0230c4a888359 extra-cmake-modules-5.69.0.tar.xz
 sha256 46cde7dc11e64c78d650b4851b88f6704b4665ff60f22a1caf68ceb15e217e5b COPYING-CMAKE-SCRIPTS
diff --git a/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.mk b/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.mk
index 3c4281b960..d3aad89264 100644
--- a/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.mk
+++ b/package/kf5/kf5-extra-cmake-modules/kf5-extra-cmake-modules.mk
@@ -15,3 +15,4 @@ KF5_EXTRA_CMAKE_MODULES_INSTALL_STAGING = YES
 KF5_EXTRA_CMAKE_MODULES_INSTALL_TARGET = NO
 
 $(eval $(cmake-package))
+$(eval $(host-cmake-package))
diff --git a/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.hash b/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.hash
index 0cd8dcfc15..a04f8b8a29 100644
--- a/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.hash
+++ b/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.hash
@@ -1,3 +1,4 @@
 # Locally calculated
 sha256 40ff04757e4ac19bc8448940fe18886c894a2069865966cc865fc55ff67b0b46 kcoreaddons-5.47.0.tar.xz
+sha256 e9cc3bc95dd2e3382d0221fbb6ebe8eb8afe5d14fbd2ce8d375eace9e4e74856 kcoreaddons-5.69.0.tar.xz
 sha256 a9bdde5616ecdd1e980b44f360600ee8783b1f99b8cc83a2beb163a0a390e861 COPYING.LIB
diff --git a/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.mk b/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.mk
index 76be8876cc..0ed2affb31 100644
--- a/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.mk
+++ b/package/kf5/kf5-kcoreaddons/kf5-kcoreaddons.mk
@@ -11,6 +11,8 @@ KF5_KCOREADDONS_LICENSE = LGPL-2.1
 KF5_KCOREADDONS_LICENSE_FILES = COPYING.LIB
 
 KF5_KCOREADDONS_DEPENDENCIES = kf5-extra-cmake-modules qt5tools
+HOST_KF5_KCOREADDONS_DEPENDENCIES = host-kf5-extra-cmake-modules host-qt5tools
+
 KF5_KCOREADDONS_INSTALL_STAGING = YES
 
 KF5_KCOREADDONS_CXXFLAGS = $(TARGET_CXXFLAGS)
@@ -27,3 +29,4 @@ KF5_KCOREADDONS_CONF_OPTS += -DCMAKE_SHARED_LINKER_FLAGS="-Wl,--no-fatal-warning
 endif
 
 $(eval $(cmake-package))
+$(eval $(host-cmake-package))
diff --git a/package/kf5/kf5.mk b/package/kf5/kf5.mk
index 8360fc9b63..3386c14ca4 100644
--- a/package/kf5/kf5.mk
+++ b/package/kf5/kf5.mk
@@ -4,7 +4,7 @@
 #
 ################################################################################
 
-KF5_VERSION_MAJOR = 5.47
+KF5_VERSION_MAJOR = 5.69
 KF5_VERSION = $(KF5_VERSION_MAJOR).0
 KF5_SITE = https://download.kde.org/stable/frameworks/$(KF5_VERSION_MAJOR)
 
diff --git a/package/qt5/qt5base/qt5base.mk b/package/qt5/qt5base/qt5base.mk
index 774c771bc9..67e5c07b86 100644
--- a/package/qt5/qt5base/qt5base.mk
+++ b/package/qt5/qt5base/qt5base.mk
@@ -433,4 +433,56 @@ define QT5BASE_INSTALL_TARGET_CMDS
 endef
 endif
 
+
+# We need a minimalistic host QT5 for the KF5 framework
+# this is needed to make and use KF5_HOST_TOOLING support
+HOST_QT5BASE_DEPENDENCIES = host-pkgconf
+
+define HOST_QT5BASE_CONFIGURE_CMDS
+	(cd $(@D); \
+		$(HOST_MAKE_ENV) \
+		PKG_CONFIG="$(PKG_CONFIG_HOST_BINARY)" \
+		MAKEFLAGS="-j$(PARALLEL_JOBS) $(MAKEFLAGS)" \
+		./configure \
+		-v \
+		-prefix /usr \
+		-extprefix $(HOST_DIR) \
+		-headerdir /usr/include/qt5 \
+		-plugindir /usr/lib/qt/plugins \
+		-examplesdir /usr/lib/qt/examples \
+		-no-rpath \
+		-nomake tests \
+		-nomake examples -no-compile-examples \
+	        -optimized-qmake \
+		-skip qtwayland \
+		-skip qtwebengine \
+	        -no-cups \
+        	-no-iconv \
+	        -system-zlib \
+        	-system-pcre \
+        	-no-pch \
+        	-shared \
+        	-no-ssl \
+		-evdev \
+		-qt-freetype \
+		-no-fontconfig \
+		-glib \
+		-opengl es2 -eglfs \
+		-no-gtk \
+		-qpa eglfs \
+        	-release \
+	        -opensource \
+        	-confirm-license \
+	)
+endef
+
+define HOST_QT5BASE_BUILD_CMDS
+	$(HOST_MAKE_ENV) $(MAKE) -C $(@D)
+endef
+
+define HOST_QT5BASE_INSTALL_CMDS
+	$(HOST_MAKE_ENV) $(MAKE) -C $(@D) install
+endef
+
 $(eval $(generic-package))
+$(eval $(host-generic-package))
diff --git a/package/qt5/qt5declarative/qt5declarative.mk b/package/qt5/qt5declarative/qt5declarative.mk
index 6210611961..50024f2050 100644
--- a/package/qt5/qt5declarative/qt5declarative.mk
+++ b/package/qt5/qt5declarative/qt5declarative.mk
@@ -63,4 +63,19 @@ define QT5DECLARATIVE_INSTALL_TARGET_CMDS
 	$(QT5DECLARATIVE_INSTALL_TARGET_LIBS)
 endef
 
+HOST_QT5DECLARATIVE_DEPENDENCIES = host-qt5base
+
+define HOST_QT5DECLARATIVE_CONFIGURE_CMDS
+	(cd $(@D); $(HOST_MAKE_ENV) $(HOST_DIR)/bin/qmake)
+endef
+
+define HOST_QT5DECLARATIVE_BUILD_CMDS
+	$(HOST__MAKE_ENV) $(MAKE) -C $(@D)
+endef
+
+define HOST_QT5DECLARATIVE_INSTALL_CMDS
+	$(HOST_MAKE_ENV) $(MAKE) -C $(@D) install
+endef
+
 $(eval $(generic-package))
+$(eval $(host-generic-package))
diff --git a/package/qt5/qt5tools/qt5tools.mk b/package/qt5/qt5tools/qt5tools.mk
index 0d00022998..5a6a3c4e1a 100644
--- a/package/qt5/qt5tools/qt5tools.mk
+++ b/package/qt5/qt5tools/qt5tools.mk
@@ -71,4 +71,28 @@ define QT5TOOLS_INSTALL_TARGET_CMDS
 		$(INSTALL) -D -m0755 $(@D)/bin/$(p) $(TARGET_DIR)/usr/bin/$(p)$(sep))
 endef
 
+
+# We need a minimalistic host QT5 for the KF5 framework
+# this is needed to make and use KF5_HOST_TOOLING support
+HOST_QT5TOOLS_DEPENDENCIES = host-qt5declarative
+
+HOST_QT5TOOLS_BUILD_DIRS_y += linguist/lconvert linguist/lrelease linguist/lupdate
+HOST_QT5TOOLS_INSTALL_HOST_DIR_y += linguist
+
+define HOST_QT5TOOLS_CONFIGURE_CMDS
+	(cd $(@D); $(HOST_MAKE_ENV) $(HOST_DIR)/bin/qmake)
+endef
+
+define HOST_QT5TOOLS_BUILD_CMDS
+	$(HOST_MAKE_ENV) $(MAKE) -C $(@D) sub-src-qmake_all
+	$(foreach p,$(HOST_QT5TOOLS_BUILD_DIRS_y), \
+		$(HOST_MAKE_ENV) $(MAKE) -C $(@D)/src/$(p)$(sep))
+endef
+
+define HOST_QT5TOOLS_INSTALL_CMDS
+	$(foreach p,$(QT5TOOLS_INSTALL_HOST_DIR_y), \
+		$(HOST_MAKE_ENV) $(MAKE) -C $(@D)/src/$(p) install$(sep))
+endef
+
 $(eval $(generic-package))
+$(eval $(host-generic-package))
diff --git a/package/qt5/qt5xmlpatterns/qt5xmlpatterns.mk b/package/qt5/qt5xmlpatterns/qt5xmlpatterns.mk
index 6ed247fd59..c6262b94b6 100644
--- a/package/qt5/qt5xmlpatterns/qt5xmlpatterns.mk
+++ b/package/qt5/qt5xmlpatterns/qt5xmlpatterns.mk
@@ -50,4 +50,19 @@ define QT5XMLPATTERNS_INSTALL_TARGET_CMDS
 	$(QT5XMLPATTERNS_INSTALL_TARGET_EXAMPLES)
 endef
 
+HOST_QT5XMLPATTERNS_DEPENDENCIES = host-qt5base host-qt5tools host-qt5declarative
+
+define HOST_QT5XMLPATTERNS_CONFIGURE_CMDS
+	(cd $(@D); $(HOST_MAKE_ENV) $(HOST_DIR)/bin/qmake)
+endef
+
+define HOST_QT5XMLPATTERNS_BUILD_CMDS
+	$(HOST_MAKE_ENV) $(MAKE) -C $(@D)
+endef
+
+define HOST_QT5XMLPATTERNS_INSTALL_CMDS
+	$(HOST_MAKE_ENV) $(MAKE) -C $(@D) install
+endef
+
 $(eval $(generic-package))
+$(eval $(host-generic-package))
-- 
2.26.1

